<div class="painel">
  <h1>Corrente da Ciência</h1>
  <h3>participe enviando sua localização</h3>
  <br>
  <div class="row">
    <div class="col-lg-12 text-center">
      <button type="button" name="button" class="botao" onclick="window.location='onde.html'">Participar</button>
    </div>
  </div>
</div>

<div class="container-map">
  <div id="map"></div>
</div>

<div class="modal fade in" id="modal_form" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">
          <i class="fa fa-map-marker" aria-hidden="true"></i> Não foi possível obter a sua localização
        </h4>
      </div>
      <div class="modal-body">
        <p>Para participar, por favor, nos informe seu estado e sua cidade:</p>
        <form>
          <select class="form-control" name="cidade" id="cidade" style="width:100%"></select>
        </form>
      </div>
      <div class="modal-footer">
        <button id="modal-error-go" type="button" class="btn btn-primary" data-dismiss="modal" onclick="send_city()">Enviar</button>
      </div>
    </div>

  </div>
</div>

<%= content_for :javascript do %>
  <script type='text/javascript'>
    $(function() {
      $("#cidade").select2({
        theme: 'bootstrap',
        language: "pt-BR",
        placeholder: 'Selecione',
        ajax: {
          url: "<%= cidades_buscar_path %>",
          dataType: 'json',
          delay: 250,
          data: function(params) {
            return {
              cidade: params.term,
            }
          },
          processResults: function (data) {
            return {
              results: data
            };
          },
          cache: true
        },
        escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
        minimumInputLength: 3
      });
    });

    var map = null;
    var visita_id = <%= @visita.id %>;

    function initModal() {
      $('#modal_form').modal('show');
    }

    function buildMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: { lat: -15.7942, lng: -47.8825 } // Brasília
      });

      options = {
        maximumAge: 600000 // 10 minutos
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          send_location(location.lat, location.lng);
        }, function(err) {
          initModal();
        }, options);
      } else {
        // Browser doesn't support Geolocation
        initModal();
      }
    }

    function show_confirmation(lat, lng) {
      var location = { lat: lat, lng: lng };

      infoWindow = new google.maps.InfoWindow;
      infoWindow.setPosition(location);
      infoWindow.setContent('Obrigado pela participação!');
      infoWindow.open(map);
      map.setCenter(location);
    }

    function send_location(lat, lng) {
        $.ajax({
            type: 'PATCH',
            url: '/create_by_location',
            data: { lat: lat, lng: lng, id: visita_id },
            success: function (data) {
              show_confirmation(lat, lng);
            }
        });
    }

    function send_city() {
      cidade = $("#cidade").val();

      $.ajax({
          type: 'PATCH',
          url: '/create_by_city',
          data: { cidade: cidade, id: visita_id },
          success: function (position) {
            show_confirmation(position.lat, position.lng);
          }
      });
    }

  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrbu5vz973WwL_JhQBRtGx3O2-lkYabSg&callback=buildMap"></script>
<% end %>
