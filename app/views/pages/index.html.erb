<div class="wrapper">
  <div class="painel">
    <h1>Corrente da Ciência</h1>
    <div id="location">
      <h3>Participe enviando sua localização!</h3>
      <br>
      <div class="row">
        <div class="col-lg-12 text-center">
          <button type="button" name="button" class="botao">Participar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<%= content_for :javascript do %>
  <script type='text/javascript'>
    $("button").click(function(){
      $("#location").html("<h3>Aguardando a localização...</h3>");
      getGeolocation();
    });

    options = {
      maximumAge: 600000 // 10 minutos
    };

    function getGeolocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          send_location(location.lat, location.lng);
        }, function(err) {
          // Redirecionar para página 'Onde'.
          searchCity();
        }, options);
      } else {
        // Browser doesn't support Geolocation
        // Redirecionar para página 'Onde'.
        searchCity();
      }
    }

    function searchCity() {
        window.location = '<%= where_path @visita.id %>';
    }

    function send_location(lat, lng) {
      $.ajax({
        type: 'PATCH',
        url: '/create_by_location',
        data: { lat: lat, lng: lng, id: <%= @visita.id %> },
        success: function (data) {
          // Redirecionar para página 'Obrigado'.
          window.location = '<%= thanks_path %>';
        }
      });
    }

  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrbu5vz973WwL_JhQBRtGx3O2-lkYabSg&callback=buildMap"></script>
<% end %>
